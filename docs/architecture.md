# 系统架构设计文档

## 1. 整体架构

### 1.1 分层架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                         客户端层 (Client Layer)                   │
│                                                                   │
│  ┌─────────────────┐    ┌──────────────────┐                    │
│  │   Web 浏览器     │    │   移动端 / 第三方  │                    │
│  │   (Vue3 SPA)    │    │   系统 (API接入)  │                    │
│  └────────┬────────┘    └────────┬─────────┘                    │
└───────────┼──────────────────────┼──────────────────────────────┘
            │ HTTP / WebSocket      │ REST API
┌───────────▼──────────────────────▼──────────────────────────────┐
│                        API 网关层 (Gateway Layer)                 │
│                                                                   │
│   ┌────────────────────────────────────────────────────────┐    │
│   │                   FastAPI Application                   │    │
│   │  ┌──────────┐  ┌──────────┐  ┌──────────┐            │    │
│   │  │JWT认证   │  │限流中间件 │  │日志中间件 │            │    │
│   │  │Middleware│  │Rate Limit│  │ Loguru   │            │    │
│   │  └──────────┘  └──────────┘  └──────────┘            │    │
│   └────────────────────────────────────────────────────────┘    │
└──────────────────┬────────────────┬────────────────┬────────────┘
                   │                │                │
┌──────────────────▼──┐  ┌─────────▼──────┐  ┌──────▼───────────┐
│    对话服务          │  │   知识库服务    │  │   用户/认证服务  │
│  ChatService        │  │KnowledgeService│  │  AuthService     │
└──────────┬──────────┘  └──────┬─────────┘  └──────────────────┘
           │                    │
┌──────────▼────────────────────▼──────────────────────────────┐
│                      核心引擎层 (Core Engine)                   │
│                                                               │
│  ┌─────────────┐  ┌─────────────┐  ┌──────────┐  ┌───────┐ │
│  │  LLM Client │  │  RAG Engine │  │ 意图识别 │  │ 记忆  │ │
│  │             │  │             │  │Classifier│  │Memory │ │
│  │ ┌─────────┐ │  │ ┌─────────┐ │  └──────────┘  └───────┘ │
│  │ │OpenAI   │ │  │ │Embedder │ │                           │
│  │ │Ollama   │ │  │ │Retriever│ │                           │
│  │ │Azure    │ │  │ │ChromaDB │ │                           │
│  │ └─────────┘ │  │ └─────────┘ │                           │
│  └─────────────┘  └─────────────┘                           │
└──────────────────────────────┬────────────────────────────────┘
                               │
┌──────────────────────────────▼────────────────────────────────┐
│                        存储层 (Storage Layer)                   │
│                                                               │
│  ┌──────────────┐  ┌──────────┐  ┌──────────────┐  ┌──────┐ │
│  │  PostgreSQL  │  │  Redis   │  │   ChromaDB   │  │ 文件 │ │
│  │ 用户/对话/   │  │ 会话缓存 │  │  向量数据库  │  │ 存储 │ │
│  │ 知识库元数据 │  │ 限流计数 │  │  知识库索引  │  │      │ │
│  └──────────────┘  └──────────┘  └──────────────┘  └──────┘ │
└───────────────────────────────────────────────────────────────┘
```

### 1.2 核心数据流

#### 用户发送消息的完整流程：

```
用户消息
   │
   ▼
[JWT认证] ──失败──▶ 401 Unauthorized
   │成功
   ▼
[限流检查] ──超限──▶ 429 Too Many Requests
   │通过
   ▼
[意图识别] ─────────────────────────────┐
   │                                    │
   ├─▶ 闲聊 (chitchat)                  │
   ├─▶ 业务咨询 (inquiry)               │ 意图分类
   ├─▶ 投诉 (complaint)                 │
   ├─▶ 售后服务 (after_sales)           │
   └─▶ 人工转接 (escalate)             ─┘
   │
   ▼
[记忆检索] → 从 Redis 加载对话历史（最近N轮）
   │
   ▼
[RAG检索] → 从 ChromaDB 检索相关知识库文档
   │
   ▼
[Prompt 组装]
   ┌────────────────────────────────────┐
   │ System Prompt (角色定义)            │
   │ + 知识库相关内容 (RAG结果)          │
   │ + 对话历史 (Memory)                │
   │ + 当前用户消息                      │
   └────────────────────────────────────┘
   │
   ▼
[LLM 推理] → OpenAI / Ollama / Azure
   │
   ▼
[流式输出] → WebSocket 逐Token推送给客户端
   │
   ▼
[对话存储] → 保存到 PostgreSQL + 更新 Redis 缓存
   │
   ▼
[质量评估] → 异步记录对话质量指标
```

## 2. 技术选型

### 2.1 后端框架 - FastAPI

**选型理由：**
- 原生支持异步 (async/await)，高并发性能优秀
- 自动生成 OpenAPI 文档
- 内置 Pydantic 数据验证
- 原生 WebSocket 支持

### 2.2 LLM 编排 - LangChain

**选型理由：**
- 统一封装多种 LLM 提供商 (OpenAI/Ollama/Azure)
- 内置 RAG Pipeline 组件
- 丰富的 Memory 管理接口
- 活跃的社区生态

### 2.3 向量数据库 - ChromaDB

**选型理由：**
- 轻量级，嵌入式部署，无需单独服务
- 支持持久化存储
- Python 原生 API，与 LangChain 深度集成
- 适合中小规模知识库（百万级向量）

> 大规模场景可迁移至 Milvus / Weaviate

### 2.4 关系数据库 - PostgreSQL

**存储内容：**
- 用户信息（认证、权限）
- 对话记录（历史归档）
- 知识库元数据（文档信息、分块记录）
- 系统统计数据

### 2.5 缓存 - Redis

**使用场景：**
- 活跃对话上下文缓存（减少DB读取）
- API 限流计数器
- JWT Token 黑名单
- 热点知识库结果缓存

## 3. 关键设计决策

### 3.1 RAG 检索策略

```
文档预处理流程：
原始文档 (PDF/Word/TXT/Markdown)
   ↓
文档解析 (pypdf / python-docx)
   ↓
文本分块 (RecursiveCharacterTextSplitter)
  - chunk_size: 500字符
  - chunk_overlap: 50字符
   ↓
向量化 (text-embedding-3-small / nomic-embed-text)
   ↓
存入 ChromaDB

检索流程：
用户查询 → 向量化 → 余弦相似度检索 → Top-K 文档 → 注入 Prompt
```

### 3.2 对话记忆管理

```
策略：滑动窗口 + Token 限制双重保障

活跃对话（Redis）：
  - 保留最近 MAX_HISTORY_TURNS(10) 轮对话
  - 超过 MAX_CONTEXT_TOKENS(4000) 时自动截断最早消息
  - TTL: 1小时

历史归档（PostgreSQL）：
  - 所有对话永久存储
  - 支持按用户/时间/意图查询
```

### 3.3 多 LLM 提供商支持

```python
# 通过环境变量切换，代码零改动
LLM_PROVIDER=openai   # 使用 OpenAI GPT
LLM_PROVIDER=ollama   # 使用本地 Ollama 模型（完全离线）
LLM_PROVIDER=azure_openai  # 使用 Azure OpenAI
```

### 3.4 流式输出方案

- **WebSocket**：前端保持长连接，后端逐 Token 推送
- **SSE (Server-Sent Events)**：备选方案，单向推送
- 实现 `AsyncIterator` 接口，兼容 LangChain 流式回调

## 4. 安全设计

| 威胁 | 防护措施 |
|------|----------|
| 未授权访问 | JWT Bearer Token 认证 |
| 暴力破解 | 登录失败限流 + 账号锁定 |
| API 滥用 | 每分钟请求数限制 (Rate Limit) |
| SQL 注入 | SQLAlchemy ORM 参数化查询 |
| Prompt 注入 | 系统 Prompt 隔离 + 输入内容过滤 |
| 敏感信息泄露 | 响应内容过滤 + 审计日志 |

## 5. 性能目标

| 指标 | 目标值 |
|------|--------|
| API 响应时延 (P95) | < 200ms（非LLM接口） |
| LLM 首 Token 时延 | < 2s |
| 并发用户数 | 100+ |
| 知识库检索时延 | < 100ms |
| 系统可用性 | 99.9% |
